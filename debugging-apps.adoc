= Lab2 - Debugging Applications
:experimental:

このラボでは、Javaリモートデバッグを使用して、coolstore マイクロサービスアプリケーションをデバッグし、Quarkus上でコードが実行される際の line-by-line のコード実行を調べます。

==== 1. Enable Remote Debugging

リモートデバッグは、アプリケーション開発に便利なデバッグ技術で、別のマシン上のどこか別の場所で実行されているコードを調べて、バグや問題を調査するのに役立つコードを行ごとに実行することができます。リモートデバッグはJava SE標準のデバッグアーキテクチャの一部であり、 https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/architecture.html[Java SE docs^] で詳細を学ぶことができます。

開発モードのQuarkusは、バックグラウンドコンパイルで「ライブコーディング」を有効にします。つまり、Javaファイルやリソースファイルを変更してブラウザを更新すると、これらの変更が自動的に有効になります。これは、設定プロパティファイルや `pom.xml` の変更などのリソースファイルに対しても機能します。

デベロッパーモード(すなわち `mvn quarkus:dev` )で実行すると、Quarkusはポート `5005` (デフォルト)のデバッグセッションもリッスンします。デバッガがアタッチされるのを待ってから実行したい場合は、コマンドラインで `-Ddebug` を渡すことができます。デバッガを全く必要としない場合は `-Ddebug=false` を使用します。

CodeReadyターミナルでこのコマンドを使用して、開発モードでローカルにInventoryマイクロサービスを起動します。

CodeReady Workspaces Terminal ウィンドウで次のコマンドを実行して、Inventory のリモート デバッグを有効にします。

[source,sh,role="copypaste"]
----
mvn quarkus:dev -f $CHE_PROJECTS_ROOT/cloud-native-workshop-v2m2-labs/inventory
----

[NOTE]
====
アプリ起動時にポート 5005 または 8080 に関するポップアップを閉じてください。
====

これで、お好きなツールを使ってデバッグを開始する準備が整いました。

コマンドが戻るのを待ってはいけません。Quarkus mavenプラグインは、転送されたポートを開いたままにして、リモートでデバッグを開始できるようにします。

image::debug-che-quarkus.png[Quarkus Debug, 700]

==== 2. Add a bug

デバッガを使って修正するバグを持つ新しいエンドポイントを追加してみましょう。

_Explorer_ view に戻り、 `cloud-native-workshop-v2m2-lab` プロジェクトの下で、 `inventory/src/main/java/com/redhat/coolstore/InventoryResource.java` ファイルを開きます。off-by-oneエラーが発生するメソッドを追加します。

[source,java,role="copypaste"]
----
    @GET
    @Path("/lastletter/{itemId}")
    @Produces("application/text-plain")
    public String lastLetter(@PathParam("itemId") String itemId) {
        Inventory item = Inventory.find("itemId", itemId).firstResult();
        String location = item.location;
        int len = location.length();
        String lastLetter = location.substring(len);
        return lastLetter;
    }
----

このメソッドは在庫のある場所を取得し、その場所の名前の最後の文字を出力する。このメソッドを追加した後、 `Seoul` に在庫があるアイテム `165613` で試してみると、最後の文字 `l` が出力されるはずです。別のターミナルを開いてコマンドを実行してください。

[source,sh,role="copypaste"]
----
curl http://localhost:8080/services/inventory/lastletter/165613
----

`l` の文字がありませんか？ よく見てください。

image::debug-che-quarkus-lastletter.png[Quarkus Debug, 700]

`l` はありません! おそらくエラーを見つけることができるでしょうが、デバッガを見てみましょう。

==== 3. Debug with CodeReady Workspaces

左側のデバッグアイコンをクリックし、ドロップダウンで *Attach to App* を選択し、緑色の *Start Debugging* アイコンををクリックします。

image::debug-che-quarkus-attach.png[Quarkus Debug, 700]

`[Warn] The debugger and the debuggee are running in different versions of JVMs. You could see wrong source mapping results.` というメッセージを見ることができます。
この警告は無視できます。JVMのバージョンが同じメジャーバージョンファミリーにある限り、問題にはなりません。

デバッグコンソールにスレッドの一覧が表示されるはずです。

[WARNING]
====
**Java Language Server に関するエラーや奇妙なメッセージが表示されたり、その他の障害が発生したりした場合**、Java Language Server を再起動する必要があるかもしれません。そのためには、 kbd:[F1] を押してコマンドウィンドウを開くか、 kbd:[Control+SHIFT+P] (Mac OS X の場合は kbd:[Command+SHIFT+P] ) を押してください。また、 *View > Find Command...* を使用することもできます。 `java` と入力し、 *Java: Clean the Java language server workspace* という名前のコマンドをクリックします。

image::clean-jls.png[JLS, 900]

これにより、 Java language server が再起動されます。再起動してワークスペースに戻ったら、もう一度 *Attach to App* の緑のアイコンをクリックしてデバッガをアタッチし、以下に進みます。
====

Explorer view に戻ります。追加した新しいメソッドで、そのメソッドの最初の行の左側をクリックしてブレークポイントを追加し、下図のように赤い点が表示されるようにします。

image::debug-che-breakpoint.png[Add Breakpoint, 700]

新しいターミナルを開き、同じ `curl` コマンドを使って新しいメソッドを呼び出します。

[source,sh,role="copypaste"]
----
curl http://localhost:8080/services/inventory/lastletter/165613
----

このコマンドは、デバッガが呼び出しを中断している間、ハングしているように表示されます。 Debugger view に切り替えて状態を確認します。

image::debug-che-breakpoint-hit.png[Add Breakpoint, 700]

*Step Over* アイコンをクリックして1行実行し、データベースから指定された製品IDのインベントリオブジェクトを取得し、黄色のカーソルが1行進むのを確認します。

左下の *Local Variables* を展開すると、メソッドに渡された `itemId` とデータベースから取得した `item` 要素の変数が表示されます。表示されない場合は、 *Locals* の横にある小さな矢印をクリックしてリストを展開してください。

image::debug-che-step-over.png[Step Over, 900]

さらに2回ステップオーバーして、`location` の値が `Seoul` であり、`len` には `Seoul` の長さが `5` に設定されていることに注意する。

image::debug-che-step-over2.png[Step Over, 600]

もう一歩踏み込んでみると、 `lastLetter` が空白 (空文字列) であることがよくわかります。これは off-by-one のエラーです!

image::debug-che-error.png[Step Over, 800]

Continueボタンをクリックしてメソッドを終了させ、空の値を `curl` に戻します。

image::debug-che-continue.png[Step Over, 600]

==== 4. Fix and Confirm

off-by-one エラーは `substring()` の呼び出しを修正するだけで修正できます。 `substring()` の行を読み込むように変更することでバグを修正してください。

[source,java,role="copypaste"]
----
        String lastLetter = location.substring(len - 1);
----

再度コマンドを実行してください。

[source,sh,role="copypaste"]
----
curl http://localhost:8080/services/inventory/lastletter/165613
----

デバッガは再び実行をキャッチします。先ほどと同じようにデバッガを使ってステップスルーし、 `lastLetter` の値が `l` であること、メソッドが終了したときに適切に返されることを確認してください。

image::debug-che-final.png[Step Over, 900]

image::debug-che-final2.png[Step Over, 1000]

[NOTE]
====
デバッガを停止するには、 *Stop Debugger* (赤枠)をクリックしてデバッガを切断し、アプリを実行しているターミナルで kbd:[CTRL-C] と入力してアプリを停止します。
====

==== Congratulations!

Quarkusアプリは、他のJavaアプリと同じようなものなので、デバッグは簡単で、多くのIDEやCLIでサポートされています。Live Reload や CodeReady Workspaces と組み合わせることで、開発を迅速かつ（比較的）苦痛なく行うことができます。
