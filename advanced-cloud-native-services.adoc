= Advanced Cloud-Native Services
:experimental:

*Cloud Native Workshop - Module 1* を終了した場合、JBoss EAP と OpenShift を使用して既存のアプリケーションをクラウドに移行する方法を学び、マイクロサービスを使用して既存のアプリケーションをモダナイズするための OpenShift の力を垣間見ることができました。 +
Module 1 を学習しなかった場合、または学習を開始したが終了しなかった場合は、以下のスクリプトを実行して追いつくことができます。

このラボでは、開発者としてOpenShift Container Platformを使用してアプリケーションを構築し、デプロイする方法をより深く掘り下げていきます。開発者に関連するOpenShiftのコア機能に焦点を当て、開発者のための典型的なワークフロー（開発、ビルド、テスト、デプロイ、リピート）を学びます。

=== ラボの準備

[WARNING]
====
*Optimizing Existing Applications* モジュールをすでに完了している場合は、このモジュールのコードをインポートする必要があります。
Import Projects セクションにスキップしてください。
====

https://www.eclipse.org/che/[Eclipse Che^] をベースにしたオンライン IDE である Red Hat CodeReady Workspaces を使用します。 *ファイルへの変更は数秒ごとに自動保存される* ので、明示的に変更を保存する必要はありません。

開始するには、 {{ ECLIPSE_CHE_URL }}[CodeReady Workspaces インスタンスにアクセス^] し、 割り当てられたユーザー名とパスワードを使用してログインします。 (例: `{{ USER_ID }}/{{ CHE_USER_PASSWORD }}`)

image::che-login.png[cdw, 700]

ログインすると、個人のダッシュボードが表示されます。以下のように、左側にあるあらかじめ作成されたワークスペースの名前をクリックします（割り当てられた番号によって名前が異なります）。また、中央のワークスペースの名前をクリックして、画面右上のOpenと書かれた緑色の {{ USER_ID }}-namespace をクリックします。

1～2分後、ワークスペースに入れられます。

image::che-workspace.png[cdw, 900]

このIDEは、Eclipse Cheをベースにしています。 +
（Eclipse Che は、MicroSoft VS Code editorをベースにしています）。

プロジェクトエクスプローラ、検索、バージョン管理(Gitなど)、デバッグ、その他のプラグインの間を移動するためのアイコンが左に表示されています。このワークショップではこれらを使います。自由にクリックして何ができるか見てみてください。

image::crw-icons.png[cdw, 400]

[NOTE]
====
ブラウザの表示がおかしくなった場合には、ブラウザタブを再読み込みして表示を更新してください。
====

CodeReady Workspaces の多くの機能は、コマンドからアクセスできます。いくつかのコマンドは、ホームページにリンクが貼られています（例：New File...、Git Clone...など）。

メニューに表示されていないコマンドを実行する必要がある場合は、 kbd:[F1] を押すか、 kbd:[Control+SHIFT+P]を押してコマンドウィンドウを開くことができます。 +
 （Mac OS Xでは kbd:[Command+SHIFT+P] ）

==== Import Projects

Let's import the project source code for this lab. Click on **Git Clone..** (or type kbd:[F1], enter 'git' and click on the auto-completed _Git Clone.._ )
このラボのプロジェクトのソースコードをインポートしてみましょう。 **Git Clone..** をクリックします。(または kbd:[F1] と入力して 'git' と入力し、自動で作成された Git クローンをクリックします。)

image::che-workspace-gitclone.png[cdw, 900]

リポジトリの URL に次の値を使用して、プロンプトに沿ってステップを実行します。FireFoxを使用している場合、最後に余分なスペースを貼り付けてしまう可能性がありますので、貼り付けた後にバックスペースを押してください。

[source,none,role="copypaste"]
----
https://github.com/RedHat-Middleware-Workshops/cloud-native-workshop-v2m2-labs.git
----

image::crw-clone-repo.png[crw,900]

プロジェクトはワークスペースにインポートされ、プロジェクト エクスプローラに表示されます。

image::crw-clone-explorer.png[crw,900]

==== IMPORTANT: 適切な Git branch を check out

プロジェクトファイルの正しいバージョンを使用していることを確認するには、CodeReadyターミナルでこのコマンドを実行してください。

[source,sh,role="copypaste"]
----
cd $CHE_PROJECTS_ROOT/cloud-native-workshop-v2m2-labs && git checkout ocp-4.5
----

[NOTE]
====
CodeReady ワークスペースのターミナルウィンドウ。Developer ワークスペースで実行しているコンテナのいずれかのターミナルウィンドウを開くことができます。これらのラボの残りの部分については、ターミナルでコマンドを実行する必要がある場合はいつでも、右側の **>_ New Terminal** コマンドを使用することができます。
====

image::codeready-workspace-terminal.png[codeready-workspace-terminal, 700]

=== Remove other projects

今日、他のモジュール( `cloud-native-workshop-v2m1-lab` など)を完了した場合は、エクスプローラーでプロジェクト名を右クリックして削除を選択し、警告を受け入れてワークスペースから削除してください。このラボのためにインポートした新しいプロジェクトを削除しないように注意してください。

image::remove-workspace.png[remove, 700]

=== Login to OpenShift

Eclipse Che ワークスペースは Kubernetes クラスタ上で実行されていますが、デフォルトの制限付きサービスアカウントで実行されているため、ほとんどのリソースタイプを作成することができません。他のモジュールを完了している場合は、もう一度ログインしてみましょう: *Login to OpenShift* をクリックして、与えられた資格情報を入力します。

* Username: `{{ USER_ID }}`
* Password: `{{ OPENSHIFT_USER_PASSWORD }}`

image::cmd-login.png[login,700]

このようなものが表示されるはずです（プロジェクト名が異なる場合があります）。

[source,none]
----
Login successful.

You have access to the following projects and can switch between them with 'oc project <projectname>':

  * {{ USER_ID }}-bookinfo
    {{ USER_ID }}-catalog
    {{ USER_ID }}-cloudnative-pipeline
    {{ USER_ID }}-cloudnativeapps
    {{ USER_ID }}-inventory
    {{ USER_ID }}-istio-system

Using project "{{ USER_ID }}-bookinfo".
Welcome! See 'oc help' to get started.
----

[NOTE]
====
 *Login to OpenShift* でログインした後は、通常のターミナルとしては使えなくなります。ターミナルのウィンドウを閉じることができます。後からさらに端末を開いてもログインしたままになります
====

==== 今日の最初のモジュールの場合はこれを行い、そうでない場合は Verifying the Dev Environment に進みます。

これらのコマンドは、module 1 からのすべてのステップをリセットして再生し、終了するまでに4～5分かかるはずです。

[WARNING]
====
*Optimizing Existing Applications lab を完了し、 `catalog` と `inventory` と CoolStore `monolith` projects を作成している場合は、これらを実行する必要はありません!*
====

[source, sh, role="copypaste"]
----
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-inventory.sh {{ USER_ID }} && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-catalog.sh {{ USER_ID }} && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-coolstore.sh {{ USER_ID }}
----

[WARNING]
====
OpenShiftではネットワークレイテンシのために新規ビルドイメージの作成に時間がかかることがあります。
もし、 *Error from server (NotFound): services "catalog-springboot" not found* となり catalog-service のデプロイに失敗した場合は、以下のコマンドを使って、もう一度試してみてください。
====

[source, sh, role="copypaste"]
----
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-inventory.sh {{ USER_ID }} && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-catalog.sh {{ USER_ID }} 3m && \
sh /projects/cloud-native-workshop-v2m2-labs/monolith/scripts/deploy-coolstore.sh {{ USER_ID }}
----

コマンドが完了するのを待ちます。

=== Verifying the Dev Environment

前のモジュールでは、 *{{ USER_ID }}-coolstore-dev* という新しいOpenShiftプロジェクトを作成し、CoolStore monolith をデプロイした開発者個人のプロジェクトを表しています。

==== Verify Application

それでは、 Monolith 用に作成されている OpenShift リソースを確認してみましょう。

* Build Config: *coolstore* build configは、ソースコードまたは WARファイル から Monolith イメージをビルドするための設定です。
* Image Stream: *coolstore* image stream は、ビルドされたすべての coolstore コンテナイメージの仮想ビューであり、OpenShift統合レジストリにプッシュされます。
* Deployment Config: *coolstore* deployment config は、新しい coolstore コンテナイメージが利用可能になるたびに、Coolstore コンテナイメージをデプロイして再デプロイします。同様に、*coolstore-postgresql* はデータベースに対しても同様のことを行います。
* Service: *coolstore* および *coolstore-postgresql* サービスは、受信した接続をそれらにプロキシするためにポッド(コンテナ)のセットを識別する内部ロードバランサです。サービスに依存するものはすべて、一貫したアドレス(サービス名またはIP)でサービスを参照することができます。
* Route: *www* route はビルトインの外部ロードバランサーにサービスを登録し、公開 DNS 名を割り当てて OpenShift クラスタの外部からアクセスできるようにします。

[NOTE]
====
`oc` コマンドで Kubernetes や OpenShift のオブジェクトタイプを参照する際には、 *buildconfig* の代わりに *bc* 、 *imagestream* の代わりに *is* 、 *deploymentconfig* の代わりに *dc* 、 *service* の代わりに *svc* などのように、長い単語の代わりに短い同義語を使用することができます。

oc describe の出力を読んで理解しようとしなくても大丈夫です。ただ、コマンドがエラーを報告しないことを確認してください!
====

これらのコマンドを実行して、CodeReady Workspacesターミナルウィンドウを介して要素を検査します。

[source,sh,role="copypaste"]
----
oc project {{ USER_ID }}-coolstore-dev && \
oc get bc coolstore && \
oc get is coolstore && \
oc get dc coolstore && \
oc get svc coolstore && \
oc describe route www
----

それぞれに有効な値を取得していることと、エラーがないことを確認してください。

coolstoreアプリ（とそのデータベース）を見るには、 {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-coolstore-dev[Topology View^] にアクセスしてください。OpenShiftウェブコンソールの開発者視点の *Topology* view は、プロジェクト内のすべてのアプリケーション、そのビルドステータス、およびそれらに関連するコンポーネントとサービスを視覚的に表示します。これは頻繁に参照することになります。

image::coolstore-dev-topology.png[crw,700]

実行中の monolith にアクセスするためのルートリンク（矢印）をクリックして、 monolith にアクセスできることを確認してください。

image::route_link.png[route_link]

coolstore のウェブインターフェースは、次のようになります。

image::coolstore_web.png[route_link, 600]


=== Verify Database

実行中のPostgresコンテナには、CodeReady Workspaces Terminalウィンドウを介して以下のようにしてログインすることができます。

[source,sh,role="copypaste"]
----
oc rsh dc/coolstore-postgresql
----

ログインしたら、次のコマンドを使用してSQL文を実行し、データベースからいくつかのコンテンツを表示してから終了します。

[source,sh,role="copypaste"]
----
psql -U $POSTGRESQL_USER $POSTGRESQL_DATABASE -c 'select name,price from PRODUCT_CATALOG;' | cat; exit
----

以下のように表示されているはずです。

----
          name          | price
------------------------+-------
 Red Fedora             | 34.99
 Forge Laptop Sticker   |   8.5
 Solid Performance Polo |  17.8
 Ogio Caliber Polo      | 28.75
 16 oz. Vortex Tumbler  |     6
 Pebble Smart Watch     |    24
 Oculus Rift            |   106
 Lytro Camera           |  44.3
 Atari 2600 Joystick    |   240
(9 rows)
----

これは、monolith のデータベースの内容を示しています。

OpenShift上で実行中のプロジェクトで、次のステップでは、開発者として実行中のアプリを使って変更を加えたり、アプリをデバッグしたりする方法を探っていきます。
